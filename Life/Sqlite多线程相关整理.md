# Sqlite多线程相关整理 #
Sqlite With MultiThreads

### 什么是线程安全? ###
当多个线程访问某个方法时，不管你通过怎样的调用方式、或者说这些线程如何交替地执行，我们在主程序中不需要去做任何的同步，这个类的结果行为都是我们设想的正确行为，那么我们就可以说这个类是线程安全的。

## 一 来自官方FAQ ##
[https://www.sqlite.org/faq.html#q5](https://www.sqlite.org/faq.html#q5)

[https://www.sqlite.org/threadsafe.html](https://www.sqlite.org/threadsafe.html)

https://blog.csdn.net/u012890196/article/details/32338505

### 同一应用程序的多个应用程序或多个实例可以同时访问单个数据库文件吗？ ###

多个进程可以同时打开同一个数据库。多个进程可以同时执行SELECT。但是，只有一个进程可以随时对数据库进行更改。
SQLite使用读取器/写入器锁来控制对数据库的访问。（在Win95 / 98 / ME下，缺少对读取器/写入器锁的支持，而是使用概率模拟。）但请注意：如果数据库文件保存在NFS文件系统上，则此锁定机制可能无法正常工作。这是因为许多NFS实现都会破坏fcntl（）文件锁定。如果多个进程可能同时尝试访问该文件，则应避免将SQLite数据库文件放在NFS上。在Windows上，Microsoft的文档说如果您没有运行Share.exe守护程序，则在FAT文件系统下锁定可能不起作用。对Windows有很多经验的人告诉我，网络文件的文件锁定是非常错误的，并且不可靠。如果他们说的是真的，
我们知道没有其他嵌入式 SQL数据库引擎支持与SQLite一样多的并发性。SQLite允许多个进程一次打开数据库文件，并允许多个进程一次读取数据库。当任何进程想要写入时，它必须在更新期间锁定整个数据库文件。但这通常只需要几毫秒。其他流程只是等待作者完成然后继续他们的业务。其他嵌入式SQL数据库引擎通常只允许单个进程一次连接到数据库。
但是，客户端/服务器数据库引擎（如PostgreSQL，MySQL或Oracle）通常支持更高级别的并发性，并允许多个进程同时写入同一数据库。这在客户端/服务器数据库中是可能的，因为总有一个良好控制的服务器进程可用于协调访问。如果您的应用程序需要大量并发，那么您应该考虑使用客户端/服务器数据库。但经验表明，大多数应用程序需要的并发性远低于设计人员的想象。
当SQLite尝试访问由另一个进程锁定的文件时，默认行为是返回SQLITE_BUSY。您可以使用sqlite3_busy_handler（）或sqlite3_busy_timeout（） API函数从C代码调整此行为 。

<font color=red>

精简版:

对于读操作:多个进程可以同时进行数据库的查询。
对于写操作:同一时间只有一个进程可以进行写操作。

多进程写操作在以下情况下可能会导致错误:

 - NFS filesystem （NFS文件系统）
 - FAT filesystems With running the Share.exe daemo （没有运行Share.exe的FAT文件系统）
 - DataBase is network files （将数据库作为一个网络文件）
 
</font>

### SQLite线程安全吗？ ###

线程是邪恶的。避免他们。
SQLite是线程安全的。我们做出这种让步，因为许多用户选择忽略前一段中给出的建议。但为了保证线程安全，必须在SQLITE_THREADSAFE预处理器宏设置为1的情况下编译SQLite。分发中的Windows和Linux预编译二进制文件都是以这种方式编译的。如果您不确定要链接的SQLite库是否被编译为线程安全，您可以调用sqlite3_threadsafe（） 接口来查找。
SQLite是线程安全的，因为它使用互斥锁来序列化对公共数据结构的访问。但是，获取和释放这些互斥锁的工作会使SQLite略微减慢。因此，如果您不需要SQLite是线程安全的，则应禁用互斥锁以获得最佳性能。有关其他信息，请参阅线程模式文档。
在Unix下，你不应该通过fork（）系统调用将一个开放的SQLite数据库带入子进程。

### 从哪个版本开始线程安全? ###

简单来说，从3.3.1版本开始，它就是线程安全的了。


### Sqlite的线程安全和传统意义上的线程安全有什么不同？ ###

threadsafe就是指在设置正确的前提下，多线程同时访问SQLite并不会影响数据库的完整性，而不是说每个线程对数据库所有的操作都可以保证正确执行。

## 二 我的多线程解决方案 ##

 - 在每个线程操作数据库时，手动加锁
 
 - 形成一个操作队列，统一去操作数据库(FMDB,GCD)











